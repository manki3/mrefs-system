{% extends "base.html" %}

{% block content %}


<div class="card info-box">
    <div>ğŸ“… ìµœì‹ í™” ë‚ ì§œ : {{ upload_time }}</div>
    <div>ğŸ“¦ ì „ì²´ ë§¤ë¬¼ ìˆ˜ : {{ properties|length }} ê°œ</div>
</div>

{% if mode == "sale" %}
<h2>ë§¤ë§¤ ë§¤ë¬¼ ëª©ë¡</h2>
{% else %}
<h2>ì›”ì„¸ ë§¤ë¬¼ ëª©ë¡</h2>
{% endif %}

<div class="card">

<form method="get">

    <input type="hidden" name="mode" value="{{ mode }}">

    <div class="filter-row">
        <strong>ë§¤ë¬¼ì¢…ë¥˜ :</strong>

        <select name="property_type" onchange="this.form.submit()">
            <option value="" {% if not property_type %}selected{% endif %}>ì „ì²´</option>
            <option value="ìƒê°€" {% if property_type == 'ìƒê°€' %}selected{% endif %}>ìƒê°€</option>
            <option value="ì‚¬ë¬´ì‹¤" {% if property_type == 'ì‚¬ë¬´ì‹¤' %}selected{% endif %}>ì‚¬ë¬´ì‹¤</option>
            <option value="ì£¼ê±°ìš©" {% if property_type == 'ì£¼ê±°ìš©' %}selected{% endif %}>ì£¼ê±°ìš©</option>
        </select>
    </div>

</form>

<div class="sort-buttons">

    <a href="/?mode={{ mode }}&property_type={{ property_type }}">ê¸°ë³¸ì •ë ¬</a>

    {% if mode == "sale" %}
        <a href="/?mode=sale&sort=sale_asc&property_type={{ property_type }}">ë§¤ë§¤ê°€ â–²</a>
        <a href="/?mode=sale&sort=sale_desc&property_type={{ property_type }}">ë§¤ë§¤ê°€ â–¼</a>
    {% else %}
        <a href="/?mode=rent&sort=rent_asc&property_type={{ property_type }}">ì›”ì„¸ â–²</a>
        <a href="/?mode=rent&sort=rent_desc&property_type={{ property_type }}">ì›”ì„¸ â–¼</a>
    {% endif %}

    <a href="/?mode={{ mode }}&sort=area_asc&property_type={{ property_type }}">í‰ìˆ˜ â–²</a>
    <a href="/?mode={{ mode }}&sort=area_desc&property_type={{ property_type }}">í‰ìˆ˜ â–¼</a>

</div>

</div>


{% for p in properties %}

<div class="detail-row">

    <!-- ë§¤ë¬¼ ì¹´ë“œ -->
    <div class="card property-card {{ p.property_type }}">
        <div class="card-left">
            <div class="title">{{ p.building_name }}</div>

            <div class="detail">
                ì¢…ë¥˜ : {{ p.property_type }}
            </div>

            <div class="detail detail-line">
                ì „ìš© : {{ p.exclusive_area }}í‰ /
                ê³„ì•½ : {{ p.contract_area }}í‰

                <span class="price-inline">
                {% if p.category == "ë§¤ë§¤" %}
                    ë§¤ë§¤ {{ format_sale_price_korean(p.sale_price) }}
                {% else %}
                    ì„ëŒ€ {{ p.deposit }}/{{ p.rent }}
                {% endif %}
                </span>
            </div>
        </div>
    </div>

    <!-- ìš°ì¸¡ ë³„ë„ ì¹´ë“œ -->
    <form method="POST" action="/add_to_collection" class="ajax-form card action-card">
    <input type="hidden" name="property_id" value="{{ p.id }}">

    <select name="collection_id" class="collection-select">
        {% for c in collections %}
            <option value="{{ c.id }}" 
    {% if existing_pairs and (p.id, c.id) in existing_pairs %}data-added="true"{% endif %}>
    {{ c.title }}
</option>
        {% endfor %}
    </select>

    <button type="submit" class="add-btn">
ë¦¬ìŠ¤íŠ¸ ë‹´ê¸°
</button>

</form>


</div>

{% endfor %}




<style>

/* ===== í•„í„° ì˜ì—­ ===== */

.filter-row{
    margin-bottom:12px;
    font-size:14px;
}

.filter-row select{
    margin-left:8px;
    padding:6px 10px;
    border-radius:8px;
    border:1px solid #d9dee7;
    background:#fff;
    font-size:14px;
    transition:0.15s;
}

.filter-row select:focus{
    outline:none;
    border-color:#2d7ff9;
    box-shadow:0 0 0 2px rgba(45,127,249,0.15);
}

/* ===== ì •ë ¬ ë²„íŠ¼ ì˜ì—­ ===== */

.sort-buttons{
    margin-top:14px;
    padding-top:8px;
    border-top:1px solid #eef1f5;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
}

.sort-buttons a{
    text-decoration:none;
    color:#333;
    background:#f3f5f9;
    padding:7px 12px;
    border-radius:10px;
    font-size:13px;
    font-weight:600;
    transition:0.15s;
}

.sort-buttons a:hover{
    background:#e4ecff;
    color:#2d7ff9;
    transform:translateY(-1px);
}

/* ===== ì¹´ë“œ ê°„ê²© ===== */

.property-card{
    margin-top:14px;
}




</style>


<script>
document.querySelectorAll('.ajax-form').forEach(form => {

    const btn = form.querySelector('.add-btn');
    const select = form.querySelector('.collection-select');

    function updateButtonState(){
        const selectedOption = select.options[select.selectedIndex];

        if(selectedOption.dataset.added === "true"){
            btn.innerText = "ì´ë¯¸ ë‹´ê¹€";
            btn.style.background = "#ccc";
            btn.disabled = true;
        }else{
            btn.innerText = "ë¦¬ìŠ¤íŠ¸ ë‹´ê¸°";
            btn.style.background = "";
            btn.disabled = false;
        }
    }

    // ìµœì´ˆ ë¡œë”© ì‹œ ìƒíƒœ ì ìš© â­ í•µì‹¬
    updateButtonState();

    // ì„ íƒ ë³€ê²½ ì‹œ ìƒíƒœ ë³€ê²½
    select.addEventListener('change', updateButtonState);

    // AJAX ì œì¶œ
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        if(btn.disabled) return;

        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(res => {
            if (res.ok) {
                const selectedOption = select.options[select.selectedIndex];
                selectedOption.dataset.added = "true";
                updateButtonState();
            } else {
                alert("ë‹´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        })
        .catch(() => alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
    });
});


// ì…€ë ‰íŠ¸ ë°•ìŠ¤ ë°”ê¿€ ë•Œë§ˆë‹¤ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
document.querySelectorAll('.collection-select').forEach(select => {
    select.addEventListener('change', function() {
        const btn = this.closest('form').querySelector('.add-btn');
        const selectedOption = this.options[this.selectedIndex];
        
        if (selectedOption.dataset.added === "true") {
            btn.innerText = "ì´ë¯¸ ë‹´ê¹€";
            btn.style.background = "#ccc";
            btn.disabled = true;
        } else {
            btn.innerText = "ë¦¬ìŠ¤íŠ¸ ë‹´ê¸°";
            btn.style.background = ""; // ê¸°ë³¸ìƒ‰ìœ¼ë¡œ ë³µêµ¬
            btn.disabled = false;
        }
    });
});
</script>


{% endblock %}
