{% extends "base.html" %}
{% block content %}

<div class="card has-mobile-panel-padding">

  <div style="margin-bottom:14px;">
    <button type="button" onclick="history.back()" style="background:#fff; border:1px solid #ddd; padding:8px 16px; border-radius:8px; font-weight:bold; cursor:pointer; color:#555;">â† ë’¤ë¡œê°€ê¸°</button>
  </div>

  <!-- ìƒë‹¨ í•œ ì¤„ -->
  <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:10px;">

    <div style="font-size:30px; font-weight:900; letter-spacing:-0.4px;">
      {{ p.building_name }}
    </div>

    <div style="font-size:24px; font-weight:900; color:#2563eb; white-space:nowrap;">
      {% if p.category == "ë§¤ë§¤" %}
        ë§¤ë§¤ {{ format_sale_price_korean(p.sale_price) }}
      {% else %}
        ì„ëŒ€ {{ p.deposit }}/{{ p.rent }}
      {% endif %}
    </div>

  </div>

  <!-- í•˜ë‹¨ ì •ë³´ -->
  <div style="margin-top:6px; font-size:16px; color:#555; font-weight:600;">
    ì „ìš© {{ p.exclusive_area }}í‰
  </div>

</div>

<div class="card" style="margin-top:18px; background:#fffbe9; border:1px solid #f1e2b8;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
    <div style="font-size:17px; font-weight:800; color:#b4850d;">ğŸ”’ ë¹„ê³µê°œ ë©”ëª¨ (ì„ëŒ€ì¸ ì •ë³´ ë“±)</div>
    <button type="button" onclick="toggleMemoEdit()" style="background:none; border:none; color:#2d7ff9; font-weight:bold; cursor:pointer; font-size:15px;">ìˆ˜ì •</button>
  </div>

  <div id="memo-display" style="font-size:15px; line-height:1.6; color:#444; white-space:pre-wrap;">{{ p.private_memo if p.private_memo else 'ë“±ë¡ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.' }}</div>

  <div id="memo-edit-container" style="display:none; margin-top:10px;">
    <textarea id="memo-textarea" style="width:100%; height:120px; padding:10px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; box-sizing:border-box;">{{ p.private_memo or '' }}</textarea>
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
      <button type="button" onclick="toggleMemoEdit()" style="padding:6px 14px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; font-weight:bold; color:#555;">ì·¨ì†Œ</button>
      <button type="button" onclick="savePropertyMemo()" style="padding:6px 14px; border-radius:6px; border:none; background:#2d7ff9; color:#fff; cursor:pointer; font-weight:bold;">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
// âœ… ì „í™”ë²ˆí˜¸ ìë™ ë§í¬ ê°ì§€ê¸°ëŠ¥
function autoLinkTel(text) {
    if(!text || text === 'ë“±ë¡ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.') return text;
    return text.replace(/(010-?\d{3,4}-?\d{4})/g, '<a href="tel:$1" style="color:#2d7ff9; font-weight:bold; text-decoration:underline;">$1</a>');
}

document.addEventListener("DOMContentLoaded", function() {
    const memoDisplay = document.getElementById("memo-display");
    if (memoDisplay) {
        memoDisplay.innerHTML = autoLinkTel(memoDisplay.innerText);
    }
});

// âœ… ë©”ëª¨ ìˆ˜ì • ëª¨ë“œ ì¼œê¸°/ë„ê¸°
function toggleMemoEdit() {
    const disp = document.getElementById("memo-display");
    const edit = document.getElementById("memo-edit-container");
    if(edit.style.display === "none") {
        disp.style.display = "none";
        edit.style.display = "block";
    } else {
        disp.style.display = "block";
        edit.style.display = "none";
    }
}

// âœ… ë©”ëª¨ ë°±ì—”ë“œ(DB)ë¡œ ì €ì¥ í†µì‹ 
function savePropertyMemo() {
    const text = document.getElementById("memo-textarea").value;
    fetch("/api/property/{{ p.id }}/memo", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ memo: text })
    })
    .then(r => r.json())
    .then(data => {
        if(data.result === "ok") {
            const disp = document.getElementById("memo-display");
            disp.innerText = data.memo || "ë“±ë¡ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.";
            disp.innerHTML = autoLinkTel(disp.innerText);
            toggleMemoEdit();
            alert("ë©”ëª¨ê°€ ì—…ë°ì´íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ‘");
        }
    });
}
</script>


<div class="card" style="margin-top:18px; padding-bottom:100px;">

  <div style="font-size:18px; font-weight:800; margin-bottom:10px;">ì‚¬ì§„</div>

  <div class="gallery">
  {% for img in images %}
    <div class="photo-wrap" data-id="{{ img.id }}">
      <input type="checkbox" class="photo-check" value="{{ img.id }}" onclick="event.stopPropagation();">
      <img src="{{ img.file_path }}" class="photo">
    </div>
  {% endfor %}
</div>

  <div class="photo-actions">
  <button type="button" id="btn-delete-selected" class="danger-btn">
    ì„ íƒ ì‚­ì œ (<span id="selected-count">0</span>)
  </button>

  <button type="button" id="btn-delete-all" class="danger-btn outline">
    ì „ì²´ ì‚­ì œ
  </button>
</div>
   
      <!-- âœ… ì‚¬ì§„ í´ë¦­ ì‹œ í¬ê²Œ ë³´ì—¬ì¤„ ëª¨ë‹¬ (ì´ì „/ë‹¤ìŒ í¬í•¨) -->
  <div id="photo-modal" class="photo-modal" style="display:none;">

    <button type="button" id="photo-prev" class="photo-nav prev">â€¹</button>
    <img id="photo-modal-img" src="" alt="big photo">
    <button type="button" id="photo-next" class="photo-nav next">â€º</button>

  </div>



    <form id="photo-upload-form" enctype="multipart/form-data">
    <!-- âœ… ìˆ¨ê¹€ íŒŒì¼ì„ íƒ input -->
    <input id="photo-input" type="file" name="images" accept="image/*" multiple style="display:none;">

    <!-- âœ… ë²„íŠ¼ í•˜ë‚˜ë§Œ ë…¸ì¶œ -->
    <button type="button" id="photo-trigger" class="primary-btn" style="margin-top:10px;">
      ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ
    </button>
  </form>


<div id="upload-toast" class="update-toast" style="display:none;">
  ì‚¬ì§„ ì—…ë¡œë“œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ‘
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

  const form = document.getElementById("photo-upload-form");
  const input = document.getElementById("photo-input");
  const gallery = document.querySelector(".gallery");
  const toast = document.getElementById("upload-toast");
  const trigger = document.getElementById("photo-trigger");

  const modal = document.getElementById("photo-modal");
  const modalImg = document.getElementById("photo-modal-img");
  const btnPrev = document.getElementById("photo-prev");
  const btnNext = document.getElementById("photo-next");

  const btnSel = document.getElementById("btn-delete-selected");
  const btnAll = document.getElementById("btn-delete-all");
  const countEl = document.getElementById("selected-count");

  let currentIndex = -1;
  let selectMode = false;

  function getPhotos(){
    return Array.from(document.querySelectorAll(".gallery .photo"));
  }

  function showByIndex(idx, direction=null){
  const photos = getPhotos();
  if(!photos.length) return;

  if(idx < 0) idx = photos.length - 1;
  if(idx >= photos.length) idx = 0;

  currentIndex = idx;

  if(direction){
    modalImg.classList.remove("photo-slide-left","photo-slide-right");
    void modalImg.offsetWidth; // ë¦¬í”Œë¡œìš° íŠ¸ë¦­

    if(direction === "left"){
      modalImg.classList.add("photo-slide-left");
    }else if(direction === "right"){
      modalImg.classList.add("photo-slide-right");
    }
  }

  modalImg.src = photos[currentIndex].src;
  modal.style.display = "flex";
}


  function openPhotoModal(e){

  // ì„ íƒëª¨ë“œì—ì„œëŠ” í™•ëŒ€ ëŒ€ì‹  ì²´í¬ í† ê¸€
  if(selectMode){
    const wrap = e.currentTarget.closest(".photo-wrap");
    const chk = wrap.querySelector(".photo-check");
    chk.checked = !chk.checked;

    countEl.innerText = document.querySelectorAll(".photo-check:checked").length;
    return;
  }

  const photos = getPhotos();
  const clicked = e.currentTarget;
  const idx = photos.indexOf(clicked);
  showByIndex(idx >= 0 ? idx : 0);
}


  document.querySelectorAll(".gallery .photo").forEach(img => {
    img.addEventListener("click", openPhotoModal);
  });

  btnPrev.addEventListener("click", e=>{
  e.stopPropagation();
  showByIndex(currentIndex - 1, "right");
});

  btnNext.addEventListener("click", e=>{
  e.stopPropagation();
  showByIndex(currentIndex + 1, "left");
});


  modal.addEventListener("click", ()=>{
    modal.style.display = "none";
    modalImg.src = "";
    currentIndex = -1;
  });

  /* ===== ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ì‚¬ì§„ ë„˜ê¸°ê¸° ===== */
let touchStartX = 0;
let touchStartY = 0;
let touchEndX = 0;
let touchEndY = 0;

modal.addEventListener("touchstart", function(e){
  if(modal.style.display === "none") return;

  const t = e.changedTouches[0];
  touchStartX = t.clientX;
  touchStartY = t.clientY;
}, {passive:true});

modal.addEventListener("touchend", function(e){
  if(modal.style.display === "none") return;

  const t = e.changedTouches[0];
  touchEndX = t.clientX;
  touchEndY = t.clientY;

  const dx = touchEndX - touchStartX;
  const dy = touchEndY - touchStartY;

  /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ì€ ë¬´ì‹œ (ëŒ€ê°ì„  ì˜¤ì‘ë™ ë°©ì§€) */
  if(Math.abs(dy) > Math.abs(dx)) return;

  /* ìµœì†Œ ìŠ¤ì™€ì´í”„ ê±°ë¦¬ */
  if(Math.abs(dx) < 40) return;

  if(dx < 0){
  showByIndex(currentIndex + 1, "left");
  }else{
  showByIndex(currentIndex - 1, "right");
  }


}, {passive:true});


  document.addEventListener("keydown", function(e){
    if(modal.style.display === "none") return;
    if(e.key === "Escape") modal.click();
    if(e.key === "ArrowLeft") showByIndex(currentIndex - 1);
    if(e.key === "ArrowRight") showByIndex(currentIndex + 1);
  });

  function showToast(){
    toast.style.display = "block";
    toast.style.opacity = "1";
    setTimeout(()=>{
      toast.style.transition="opacity 0.5s";
      toast.style.opacity="0";
      setTimeout(()=>{ toast.style.display="none"; toast.style.transition=""; }, 500);
    }, 1200);
  }

  trigger.addEventListener("click", ()=> input.click());

  input.addEventListener("change", async function(){
    if(!input.files || !input.files.length) return;

    trigger.disabled = true;
    trigger.innerText = "ì—…ë¡œë“œ ì¤‘...";

    const fd = new FormData();
    for(const f of input.files) fd.append("images", f);

    const res = await fetch("/upload_images/{{ p.id }}",{method:"POST",body:fd});
    if(!res.ok){ alert("ì—…ë¡œë“œ ì‹¤íŒ¨"); return; }

    for(const f of input.files){
      const url = URL.createObjectURL(f);
      const img = document.createElement("img");
      img.src = url;
      img.className = "photo";
      gallery.prepend(img);
      img.addEventListener("click", openPhotoModal);
    }

    input.value="";
    showToast();
    trigger.disabled=false;
    trigger.innerText="ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ";
  });

  function getChecked(){
    return Array.from(document.querySelectorAll(".photo-check:checked"))
      .map(e=>parseInt(e.value));
  }

  function exitSelectMode(){
    selectMode=false;
    gallery.classList.remove("select-mode");
    document.querySelectorAll(".photo-check").forEach(c=>c.checked=false);
    countEl.innerText=0;
    btnSel.innerText="ì„ íƒ ì‚­ì œ";
    btnAll.innerText="ì „ì²´ ì‚­ì œ";
  }

  btnSel.addEventListener("click", async ()=>{
    if(!selectMode){
      selectMode=true;
      gallery.classList.add("select-mode");
      btnSel.innerText="ì‚­ì œ ì‹¤í–‰";
      btnAll.innerText="ì·¨ì†Œ";
      return;
    }

    const ids=getChecked();
    if(!ids.length){ alert("ì‚­ì œí•  ì‚¬ì§„ ì„ íƒ"); return; }
    if(!confirm(ids.length+"ì¥ ì‚­ì œí• ê¹Œìš”?")) return;

    const res=await fetch("/delete_images_selected/{{ p.id }}",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({image_ids:ids})
    });

    if(!res.ok){ alert("ì‚­ì œ ì‹¤íŒ¨"); return; }

    ids.forEach(id=>{
      document.querySelector(`.photo-wrap[data-id="${id}"]`)?.remove();
    });

    exitSelectMode();
  });

  btnAll.addEventListener("click", async ()=>{
    if(selectMode){ exitSelectMode(); return; }

    if(!confirm("ì „ì²´ ì‚­ì œí• ê¹Œìš”?")) return;

    const res=await fetch("/delete_images/{{ p.id }}",{method:"POST"});
    if(!res.ok){ alert("ì‚­ì œ ì‹¤íŒ¨"); return;}

    document.querySelectorAll(".photo-wrap").forEach(e=>e.remove());
  });

});
</script>

<script>
document.addEventListener("DOMContentLoaded", function(){

  const form = document.querySelector(".detail-ajax-form");
  if(!form) return;

  const select = form.querySelector(".detail-collection-select");
  const btn = form.querySelector(".detail-add-btn");

  function updateButton(){
    const opt = select.options[select.selectedIndex];
    if(opt.dataset.added === "true"){
      btn.disabled = true;
      btn.innerText = "ì´ë¯¸ ë‹´ê¹€";
      btn.style.background = "#cbd5e1";
    }else{
      btn.disabled = false;
      btn.innerText = "ë¦¬ìŠ¤íŠ¸ ë‹´ê¸°";
      btn.style.background = "";
    }
  }

  updateButton();
  select.addEventListener("change", updateButton);

  form.addEventListener("submit", function(e){
    e.preventDefault();
    if(btn.disabled) return;

    fetch(form.action, { method:"POST", body:new FormData(form) })
      .then(r=>{
        if(r.status === 204){
          select.options[select.selectedIndex].dataset.added = "true";
          updateButton();
        }else{
          alert("ë‹´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      })
      .catch(()=> alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
  });

});
</script>




</div>

<!-- ì¼ë°˜ ëª©ë¡ì—ì„œ ë“¤ì–´ì™”ì„ ë•Œë§Œ: ë¦¬ìŠ¤íŠ¸ ë‹´ê¸° -->
{% if not from_collection_id %}
<div class="mobile-add-panel" onclick="event.stopPropagation();">
  <form method="POST" action="/add_to_collection" class="detail-ajax-form">
    <input type="hidden" name="property_id" value="{{ p.id }}">

    <select name="collection_id" class="detail-collection-select">
      {% for c in collections %}
        <option value="{{ c.id }}"
          {% if (p.id, c.id) in existing_pairs %}data-added="true"{% endif %}>
          {{ c.title }}
        </option>
      {% endfor %}
    </select>

    <button type="submit" class="detail-add-btn">ë¦¬ìŠ¤íŠ¸ ë‹´ê¸°</button>
  </form>
</div>
{% endif %}

<!-- ì»¬ë ‰ì…˜ì—ì„œ ë“¤ì–´ì™”ì„ ë•Œë§Œ: ë¦¬ìŠ¤íŠ¸ ì œê±° -->
{% if from_collection_id %}
<div class="mobile-remove-panel" onclick="event.stopPropagation();">
  <form method="POST" action="{{ url_for('remove_from_collection', collection_id=from_collection_id
, property_id=p.id) }}">
    <input type="hidden" name="collection_id" value="{{ from_collection_id }}">
    <input type="hidden" name="property_id" value="{{ p.id }}">
    <button type="submit" class="mobile-remove-btn">ë¦¬ìŠ¤íŠ¸ ì œê±°</button>
  </form>
</div>
{% endif %}




<style>
.gallery{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(120px, 1fr));
  gap:10px;
}

.photo{
  width:100%;
  height:120px;
  object-fit:cover;
  border-radius:10px;
  cursor:pointer;
  border:1px solid #e5e7eb;
  display:block;
}

/* âœ… ì „ì²´í™”ë©´ ì‚¬ì§„ í™•ëŒ€ ëª¨ë‹¬ */
.photo-modal{
  position:fixed;
  left:0;
  top:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.82);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:99999;
  padding:20px;
}

.photo-modal img{
  max-width:95vw;
  max-height:90vh;
  border-radius:12px;
  box-shadow:0 12px 30px rgba(0,0,0,0.35);
}

/* ìŠ¤ì™€ì´í”„ ì• ë‹ˆë©”ì´ì…˜ */
.photo-slide-left{
  animation: slideLeft 0.18s ease;
}

.photo-slide-right{
  animation: slideRight 0.18s ease;
}

@keyframes slideLeft{
  from{ transform:translateX(35px); opacity:0.5; }
  to{ transform:translateX(0); opacity:1; }
}

@keyframes slideRight{
  from{ transform:translateX(-35px); opacity:0.5; }
  to{ transform:translateX(0); opacity:1; }
}


/* âœ… ëª¨ë‹¬ ì´ì „/ë‹¤ìŒ ë²„íŠ¼ */
.photo-nav{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  width:56px;
  height:56px;
  border:none;
  border-radius:999px;
  background:rgba(255,255,255,0.18);
  color:#fff;
  font-size:40px;
  line-height:56px;
  cursor:pointer;
  user-select:none;
}

.photo-nav:hover{
  background:rgba(255,255,255,0.28);
}

.photo-nav.prev{ left:18px; }
.photo-nav.next{ right:18px; }


.primary-btn{
  width:100%;
  height:44px;
  border:none;
  border-radius:10px;
  background:#2d7ff9;
  color:#fff;
  font-weight:800;
  font-size:15px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}
.primary-btn:hover{ opacity:0.92; }
.primary-btn:disabled{ background:#bfc7d5; cursor:not-allowed; }

.photo-wrap{
  position:relative;
}

.photo-check{
  position:absolute;
  top:8px;
  left:8px;
  width:18px;
  height:18px;
  z-index:10;
  cursor:pointer;
  display:none;
}

/* ì„ íƒëª¨ë“œì¼ë•Œë§Œ ë³´ì´ê²Œ */
.gallery.select-mode .photo-check{
  display:block;
}


.photo-actions{
  display:flex;
  gap:10px;
  margin-top:12px;
}

.danger-btn{
  flex:1;
  height:40px;
  border:none;
  border-radius:10px;
  background:#ff9f43;      /* ì—°í•œ ì£¼í™© */
  color:#fff;
  font-weight:800;
  font-size:14px;
  cursor:pointer;
  transition:all 0.15s ease;
}

.danger-btn:hover{
  background:#ff8c2a;
}

.danger-btn.outline{
  background:#fff;
  color:#ff9f43;
  border:2px solid #ff9f43;
}




.danger-btn:disabled{
  background:#ffc9c9;
  cursor:not-allowed;
}


/* âœ… í•˜ë‹¨ íŒ¨ë„ì´ ë‚´ìš© ê°€ë¦¬ì§€ ì•Šê²Œ */
.has-mobile-panel-padding{
  padding-bottom:88px;
}

/* âœ… ëª¨ë°”ì¼ ìƒì„¸í˜ì´ì§€ í•˜ë‹¨ ê³ ì • íŒ¨ë„ */
.mobile-add-panel{
  position:fixed;
  left:0; right:0; bottom:0;
  background:#fff;
  border-top:1px solid #e5e7eb;
  padding:12px;
  box-shadow:0 -10px 22px rgba(0,0,0,0.10);
  z-index:9999;
}

.mobile-add-panel .detail-ajax-form{
  display:flex;
  gap:10px;
  align-items:center;
}

.mobile-add-panel .detail-collection-select{
  flex:1;
  height:46px;
  border-radius:12px;
  padding:0 12px;
  border:1px solid #d1d5db;
  background:#fff;
  font-size:16px;
}

.mobile-add-panel .detail-add-btn{
  width:120px;
  height:46px;
  border:none;
  border-radius:12px;
  background:#2d7ff9;
  color:#fff;
  font-weight:800;
  cursor:pointer;
}

/* âœ… PCì—ì„œëŠ” íŒ¨ë„ ìˆ¨ê¹€ + íŒ¨ë”© ì œê±° */
@media (min-width:801px){
  .mobile-add-panel{ display:none; }
  .has-mobile-panel-padding{ padding-bottom:0; }
}



/* ì»¬ë ‰ì…˜ ìƒì„¸ì—ì„œë§Œ í‘œì‹œë˜ëŠ” ì œê±° ë²„íŠ¼ */
.mobile-remove-panel{
  position:fixed;
  left:0; right:0; bottom:0;
  background:#fff;
  border-top:1px solid #e5e7eb;
  padding:12px;
  box-shadow:0 -10px 22px rgba(0,0,0,0.10);
  z-index:9999;
}

.mobile-remove-btn{
  width:100%;
  height:46px;
  border:none;
  border-radius:12px;
  background:#ef4444;
  color:#fff;
  font-weight:900;
  font-size:16px;
}

/* PCì—ì„œëŠ” ì œê±° ë²„íŠ¼ ìˆ¨ê¹€ */
@media (min-width:801px){
  .mobile-remove-panel{ display:none; }
}



</style>


{% endblock %}
